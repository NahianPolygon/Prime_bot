# ðŸ”Œ API SPECIFICATION â€“ Chat Endpoint

This document specifies the **single stable API** that your frontend calls.

---

## 1. Endpoint Overview

### Chat API (Single Entry Point)
```
POST /api/chat
```

---

## 2. Request Schema (Pydantic)

### ChatRequest

```python
from pydantic import BaseModel
from typing import Literal

class ChatRequest(BaseModel):
    session_id: str
    user_message: str
    channel: Literal["web", "mobile"]
    language: Literal["en", "bn"] = "en"

    class Config:
        example = {
            "session_id": "sess_abc123xyz",
            "user_message": "Can a 16-year-old open Prime First Account?",
            "channel": "web",
            "language": "en"
        }
```

### Field Definitions

| Field | Type | Required | Purpose |
|-------|------|----------|---------|
| `session_id` | str | Yes | Unique conversation session identifier. Generated by frontend (localStorage UUID). |
| `user_message` | str | Yes | User's natural language query. |
| `channel` | Literal["web", "mobile"] | Yes | Platform origin (enables future UX differences). |
| `language` | Literal["en", "bn"] | No | Language preference (default: "en"). |

---

## 3. Response Schema (Pydantic)

### ChatResponse

```python
from pydantic import BaseModel
from typing import Optional

class ChatResponse(BaseModel):
    message: str
    domain: str
    vertical: str
    agent: str
    sources: list[str]
    confidence: float
    refusal: bool

    class Config:
        example = {
            "message": "Yes, a 16-year-old can open Prime First Account. You need a minimum balance of à§³1,000 and a valid ID.",
            "domain": "conventional",
            "vertical": "save",
            "agent": "eligibility_graph",
            "sources": ["knowledge/products/conventional/save/deposit_accounts/prime_first_account.md"],
            "confidence": 0.92,
            "refusal": False
        }
```

### Field Definitions

| Field | Type | Purpose |
|-------|------|---------|
| `message` | str | Human-readable response text. This is what you render on frontend. |
| `domain` | str | Domain that answered: "conventional", "islami", or "nrb". |
| `vertical` | str | Vertical/category: "save", "credit_card", or "debit". |
| `agent` | str | Which graph/agent answered: "eligibility_graph", "comparison_graph", "onboarding_graph", etc. |
| `sources` | list[str] | File paths or doc IDs used to build response. |
| `confidence` | float | System confidence score (0.0â€“1.0). If < 0.5, consider clarification. |
| `refusal` | bool | True if request violated policy (e.g., Islami+Conventional numeric comparison). |

---

## 4. Example Conversations

### Scenario 1: Eligibility Check
**Request:**
```json
{
  "session_id": "sess_user123",
  "user_message": "Can a 16-year-old with 5,000 taka open Prime First Account?",
  "channel": "web",
  "language": "en"
}
```

**Response:**
```json
{
  "message": "Yes, a 16-year-old with à§³5,000 can open Prime First Account. Minimum age is 13 and minimum balance is à§³1,000. You meet both requirements.",
  "domain": "conventional",
  "vertical": "save",
  "agent": "eligibility_graph",
  "sources": ["knowledge/products/conventional/save/deposit_accounts/prime_first_account.md"],
  "confidence": 0.95,
  "refusal": false
}
```

---

### Scenario 2: Product Comparison (Allowed)
**Request:**
```json
{
  "session_id": "sess_user123",
  "user_message": "What's the difference between Prime First Account and Prime Youth Account?",
  "channel": "web",
  "language": "en"
}
```

**Response:**
```json
{
  "message": "Prime First Account (min age 13, min balance à§³1,000) and Prime Youth Account (min age 18, min balance à§³500) differ in eligibility. Youth Account is for older customers with lower minimum balance requirements.",
  "domain": "conventional",
  "vertical": "save",
  "agent": "comparison_graph",
  "sources": [
    "knowledge/products/conventional/save/deposit_accounts/prime_first_account.md",
    "knowledge/products/conventional/save/deposit_accounts/prime_youth_account.md"
  ],
  "confidence": 0.88,
  "refusal": false
}
```

---

### Scenario 3: Restricted Comparison (Refusal)
**Request:**
```json
{
  "session_id": "sess_user123",
  "user_message": "Which gives more profit, Islami DPS or conventional DPS?",
  "channel": "web",
  "language": "en"
}
```

**Response:**
```json
{
  "message": "I cannot compare Islami and conventional products numerically. Islami deposits offer profit-sharing (Mudaraba), while conventional deposits offer interest. I can explain how each works separately.",
  "domain": "nrb",
  "vertical": "save",
  "agent": "policy_guard",
  "sources": [],
  "confidence": 0.98,
  "refusal": true
}
```

---

### Scenario 4: Low Confidence (Clarification Needed)
**Request:**
```json
{
  "session_id": "sess_user123",
  "user_message": "I want something safe",
  "channel": "web",
  "language": "en"
}
```

**Response:**
```json
{
  "message": "I'd like to help! Could you clarify: Are you looking for a savings account, investment scheme, or credit card? And do you have a preference for Islamic (Shariah-compliant) or conventional banking?",
  "domain": null,
  "vertical": null,
  "agent": "clarification_agent",
  "sources": [],
  "confidence": 0.35,
  "refusal": false
}
```

---

## 5. HTTP Status Codes

| Code | Meaning | Example |
|------|---------|---------|
| 200 | Success | Normal chat response |
| 400 | Bad Request | Invalid JSON, missing field |
| 422 | Validation Error | Invalid `channel` value |
| 500 | Server Error | Internal exception |

---

## 6. Error Response Schema

See [ERROR_HANDLING.md](ERROR_HANDLING.md) for detailed error responses.

Quick example:

```json
{
  "error_code": "INTENT_LOW_CONFIDENCE",
  "message": "Could you please clarify what you want to know?"
}
```

---

## 7. Frontend Integration Example

### HTML/JavaScript

```html
<script>
async function sendMessage() {
  const sessionId = localStorage.getItem("sessionId") || generateUUID();
  localStorage.setItem("sessionId", sessionId);

  const request = {
    session_id: sessionId,
    user_message: document.getElementById("inputBox").value,
    channel: "web",
    language: "en"
  };

  const response = await fetch("/api/chat", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(request)
  });

  const data = await response.json();
  
  // Render response
  document.getElementById("chatBox").innerHTML += 
    `<div class="message">${data.message}</div>`;
  
  // Optional: Show confidence
  if (data.confidence < 0.5) {
    console.log("Low confidence response - consider clarification");
  }
}

function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}
</script>
```

---

## 8. Backward Compatibility

This API schema will remain stable. Future fields will be optional and added only if necessary.

